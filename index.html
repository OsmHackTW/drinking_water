<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>飲水地圖</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="leaflet.js"></script>
    <script src="OverPassLayer.js"></script>
    <script src="L.Control.Locate.min.js"></script>
    <script src="easy-button.js"></script>
    <link rel="stylesheet" href="leaflet.css">
    <link rel="stylesheet" href="OverPassLayer.css">
    <link rel="stylesheet" href="L.Control.Locate.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <style type="text/css" media="screen">
      body {
        padding: 0;
        margin: 0;
      }
      html, body, #map {
        height: 100%;
      }
      .leaflet-popup-content .name {
        font-weight: bold;
        font-size: 1.2em;
        line-height: 2.1;
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalabel=no"/>
  </head>
  <body>
    <div id="map"></div>
    <style>
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        background: #000;
        filter: alpha(opacity=50);
      }
      #modal {
        position: absolute;
        background: url(tint20.png) 0 0 repeat;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 14px;
        padding: 8px;
      }
      #content {
        border-radius: 8px;
        background: #fff;
        padding: 20px;
      }
      #close {
        position:absolute;
        background:url(close.png) 0 0 no-repeat;
        width:24px;
        height:27px;
        display:block;
        text-indent:-9999px;
        top:-7px;
        right:-7px;
      }
    </style>
    <script>
      function waterDropIcon() {
        return L.icon({
          iconUrl: 'waterdrop.png',
          iconSize: [29, 40],
          iconAnchor: [15, 40],
          popupAnchor: [1, -20],
        });
      }

      var attr_osm = '地圖資料 &copy; <a href="http://openstreetmap.org/">OpenStreetMap</a>';
      var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        opacity: 0.7,
        maxZoom: 18,
        attribution: attr_osm,
      });

      var map = new L.Map('map').addLayer(osm).setView(new L.LatLng(24, 121), 15);

      var drinkingWaterLayer = new L.OverPassLayer({
        query: 'area(3600449220)->.searchArea;(node["amenity"="drinking_water"](area.searchArea);node["drinking_water"="yes"](area.searchArea);way["amenity"="drinking_water"](area.searchArea);way["drinking_water"="yes"](area.searchArea);relation["amenity"="drinking_water"](area.searchArea););out;',
        callback: function (data) {
          for(var i = 0; i < data.elements.length; i++) {
            var e = data.elements[i];
            if (e.id in this.instance._ids) return;
            e.tags.name = e.tags.name || '飲水機';
            e.tags.level = e.tags.level ? (+e.tags.level < 0 ? '地下 ' + -e.tags.level : e.tags.level) + ' 樓' : undefined;
            this.instance._ids[e.id] = true;
            var pos = new L.LatLng(e.lat, e.lon);
            var popup = '<div>'
              + '<div class="name">' + e.tags.name + '</div>'
              + '<div class="water">'
              + (e.tags.cold_water ? '<img src="iced.png"/>' : '')
              + (e.tags.warm_water ? '<img src="warm.png"/>' : '')
              + (e.tags.hot_water ? '<img src="hot.png"/>' : '')
              + '</div>'
              + (e.tags.description ? '<div class="description">' + e.tags.description + '</div>' : '')
              + (e.tags.level ? '<div class="level">' + e.tags.level + '</div>' : '')
              + '</div>';
            var color = e.tags.collection_times ? 'green':'red';
            var marker = L.marker(pos, {
              icon: waterDropIcon(),
              fillColor: '#fa3',
              fillOpacity: 0.5
            }).bindPopup(popup);
            this.instance.addLayer(marker);
          }
        },
        minZoomIndicatorOptions: {
          position: 'topright',
          minZoomMessageNoLayer: '',
          minZoomMessage: '',
        },
      });
      map.addLayer(drinkingWaterLayer);

      function onLocationError(e) {
        console.log(e.message);
      }

      var locateControl = L.control.locate({
        icon: 'fa fa-map-marker',
        iconLoading: 'fa fa-spinner fa-spin',
        onLocationError: onLocationError,
        locateOptions: {
          maxZoom: 16,
        },
      }).addTo(map);
      locateControl.start();

      var modal = (function () {
        var method = {};
        var $overlay = $('<div id="overlay"></div>');
        var $modal = $('<div id="modal"></div>');
        var $content = $('<div id="content"></div>');
        var $close = $('<a id="close" href="#">close</a>');

        // Append the HTML
        $modal.hide();
        $overlay.hide();
        $modal.append($content, $close);
        $(document).ready(function () {
          $('body').append($overlay, $modal);
        });

        // Center the modal in the viewport
        method.center = function () {
          var top, left;
          top = Math.max($(window).height() - $modal.outerHeight(), 0) / 2;
          left = Math.max($(window).width() - $modal.outerWidth(), 0) / 2;
          $modal.css({
              top: top + $(window).scrollTop(),
              left: left + $(window).scrollLeft()
          });
        };
        // Open the modal
        method.open = function (settings) {
          $content.empty().append(settings.content);
          $modal.css({
              width: settings.width || 'auto',
              height: settings.height || 'auto'
          })
          method.center();
          $(window).bind('resize.modal', method.center);
          $modal.show();
          $overlay.show();
        };
        // Close the modal
        method.close = function () {
          $modal.hide();
          $overlay.hide();
          $content.empty();
          $(window).unbind('resize.modal');
        };
        $close.click(function(e){
            e.preventDefault();
            method.close();
        });
        return method;
      })();

      function onAbout(e) {
        modal.open({
          content: '<p>一個600ml的瓶裝水，需要耗費600ml的6~7倍水量製造它的塑膠瓶！在缺水的時代來臨時，別再讓塑膠瓶跟我們搶水資源了！</p><p>自備環保杯是個絕佳的選擇，但是喝完自備的水後怎麼辦？</p><p>從現在開始，我們要讓帶環保杯的朋友，可以快速的找到補水地點，讓大家隨心所欲的喝水保健康。</p><p>此外，<a href="http://www.e-info.org.tw/">台灣環境資訊協會</a>懇請大家，少喝瓶裝水，努力減少塑膠瓶及瓶蓋等海洋垃圾，減少海鳥、海龜、鯨豚…等海洋生物吞食這些塑膠垃圾而痛苦至死。您的努力，也將是他們活命的機會！</p>',
          width: $(window).width() > 400 ? $(window).width() / 1.5 : $(window).width() / 1.1
        });
      }
      L.easyButton('fa fa-question-circle', onAbout, '關於飲水地圖', map);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalabel=no"/>
    <title>飲水地圖</title>

    <meta property="og:title" content="飲水地圖"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="http://drinking.teia.tw/"/>
    <meta property="og:image" content="http://drinking.teia.tw/image.jpg"/>
    <meta property="og:description" content="一個600ml的瓶裝水，需要耗費600ml的6~7倍水量製造它的塑膠瓶！在缺水的時代來臨時，別再讓塑膠瓶跟我們搶水資源了！"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="@teiatw"/>
    <meta name="keywords" content="water, map, 飲水, 飲水機, 地圖, 社群, OpenStreetMap, 開放街圖, 台灣環境資訊協會"/>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="leaflet.js"></script>
    <script src="OverPassLayer.js"></script>
    <script src="L.Control.Locate.min.js"></script>
    <script src="Leaflet.GraphicScale.min.js"></script>
    <script src="easy-button.js"></script>

    <link rel="stylesheet" href="leaflet.css"/>
    <link rel="stylesheet" href="OverPassLayer.css"/>
    <link rel="stylesheet" href="L.Control.Locate.min.css"/>
    <link rel="stylesheet" href="Leaflet.GraphicScale.min.css"/>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>
    <style type="text/css" media="screen">
      body { padding: 0; margin: 0; }
      html, body, #map { height: 100%; }
      .leaflet-popup-content .name {
        font-weight: bold;
        font-size: 1.2em;
        line-height: 2.1;
      }
    </style>
    <style>
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.5;
        background: #000;
        filter: alpha(opacity=50);
      }
      #modal {
        position: absolute;
        background: url(tint20.png) 0 0 repeat;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 14px;
        padding: 8px;
      }
      #content {
        border-radius: 8px;
        background: #fff;
        padding: 20px;
      }
      #close {
        position:absolute;
        background:url(close.png) 0 0 no-repeat;
        width:24px;
        height:27px;
        display:block;
        text-indent:-9999px;
        top:-7px;
        right:-7px;
      }
      #locator {
        position: absolute;
        bottom: 70px;
        right: 40px;
      }
      #showNextTime {
        position: absolute;
        bottom: 25px;
        right: 40px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="modal">
      <div id="content">
        <p>一個600ml的瓶裝水，需要耗費600ml的6~7倍水量製造它的塑膠瓶！在缺水的時代來臨時，別再讓塑膠瓶跟我們搶水資源了！</p>
        <p>自備環保杯是個絕佳的選擇，但是喝完自備的水後怎麼辦？</p>
        <p>從現在開始，我們要讓帶環保杯的朋友，可以快速的找到補水地點，讓大家隨心所欲的喝水保健康。</p>
        <p>此外，<a href="http://www.e-info.org.tw/" target="_blank">台灣環境資訊協會</a>懇請大家，少喝瓶裝水，努力減少塑膠瓶及瓶蓋等海洋垃圾，減少海鳥、海龜、鯨豚…等海洋生物吞食這些塑膠垃圾而痛苦至死。您的努力，也將是他們活命的機會！</p>
        <p><a href="https://osmtw.hackpad.com/afSMeOLuHkR" target="_blank">計劃網站</a></p>
        <p><a href="https://docs.google.com/document/d/1by9-SqfJ6qvu0dGER4E63bKsvGp3LhoqK86XFHHM_JI/edit?usp=sharing" target="_blank">一起編輯飲水地圖</a></p>
        <p><a href="https://e-info.neticrm.tw/civicrm/contribute/transact?reset=1&id=9" target="_blank">捐款給台灣環境資訊協會</a></p>
      </div>
    </div>
    <script>
      function screenSize() {
        return $(window).width() > 400 ? 'large' : 'small';
      }

      var map = new L.Map('map')

      function userLocator(map, s) {
        var settings = s || {
          setView: true,
          maxZoom: 17
        };
        var component = {}
        var button
        var circle

        function onLocationFound (e) {
          console.log(e)
          if (circle === undefined) {
            circle = L.circle(e.latlng, 200).addTo(map)
          } else {
            circle.setLatLng(e.latlng).setRadius(200)
          }
        }

        function onLocationError (e) {
          console.log(e)
        }

        map.on('locationfound', onLocationFound)
        map.on('locationerror', onLocationError)
        map.on('stopfollowing', function (e) {
          if (circle !== undefined) {
            circle.setRadius(0)
          }
        })

        component.button = function () {
          if (arguments.length === 1) {
            button = arguments[0]
            return component
          }
          if (button === undefined) {
            button = L.control.locate({
              icon: 'fa fa-map-marker',
              iconLoading: 'fa fa-spinner fa-spin',
              drawCircle: false,
              follow: true,
              onLocationError: onLocationError,
              locateOptions: settings
            })
          }
          return button
        }

        component.start = function () {
          component.button().start()
        }

        component.stop = function () {
          component.button().stop()
        }

        component.mapButton = function () {
          return function () {
            var map = this;
            component.button().addTo(map);
          }
        }

        return component
      }
      var locator = userLocator(map)

      function aboutModal (locator, s) {
        var settings = s || {}
        var component = {};

        var $overlay = $('<div id="overlay"></div>')
        var $modal = $('#modal')
        var $content = $('#content')
        var $close = $('<a id="close" href="#">close</a>')
        var $showNextTime = $('<label id="showNextTime"><input type="checkbox"></input>下次顯示這個訊息</label>')
        var $locator = $('<a id="locator" href="#">顯示我的位置</a>')

        $modal.hide();
        $overlay.hide();
        $modal.append($content, $close, $locator, $showNextTime);

        component.mount = function () {
          $('body').append($overlay, $modal);
        }

        component.center = function () {
          var top, left;
          top = Math.max($(window).height() - $modal.outerHeight(), 0) / 2;
          left = Math.max($(window).width() - $modal.outerWidth(), 0) / 2;
          $modal.css({
            top: top + $(window).scrollTop(),
            left: left + $(window).scrollLeft()
          });
        };

        component.open = function () {
          $('.leaflet-control').css('display', 'none')
          $modal.css({
              width: settings.width || 'auto',
              height: settings.height || 'auto'
          })
          component.center();
          $(window).bind('resize.modal', component.center);
          $modal.show();
          $overlay.show();
        };

        component.close = function () {
          $('.leaflet-control').css('display', 'inherit')
          $modal.hide();
          $overlay.hide();
          $(window).unbind('resize.modal');
        };

        $close.click(function(e){
          e.preventDefault();
          component.close();
        });

        $locator.click(function (e) {
          e.preventDefault()
          locator.start()
          component.close()
        })

        $showNextTime.click(function (e) {
          window.localStorage.showNextTime = $(this).children()[0].checked
        })

        component.showNextTime = function () {
          return window.localStorage.showNextTime === undefined || window.localStorage.showNextTime === 'true'
        }

        $showNextTime.children()[0].checked = component.showNextTime()

        component.mapButton = function (settings) {
          return function () {
            var map = this;
            function onClick(e) {
              component.open();
            }
            L.easyButton('fa fa-question-circle', onClick, '關於飲水地圖', map);
          };
        }

        return component;
      }
      var about = aboutModal(locator, {
        width: screenSize() === 'large' ? $(window).width() / 1.5 : $(window).width() / 1.1
      })

      function osmLayer() {
        var attr_osm = '地圖資料 &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';
        return new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          opacity: 0.7,
          maxZoom: 18,
          attribution: attr_osm,
        });
      }

      function waterDropIcon() {
        return L.icon({
          iconUrl: 'waterdrop.png',
          iconSize: [29, 40],
          iconAnchor: [15, 40],
          popupAnchor: [1, -20],
        });
      }

      function drinkingWaterLayer() {
        return function () {
          var map = this;
          var l = new L.OverPassLayer({
            query: 'area(3600449220)->.searchArea;(node["amenity"="drinking_water"](area.searchArea);node["drinking_water"="yes"](area.searchArea);way["amenity"="drinking_water"](area.searchArea);way["drinking_water"="yes"](area.searchArea);rel["amenity"="drinking_water"](area.searchArea);rel["drinking_water"="yes"](area.searchArea););out;',
            callback: function (data) {
              for(var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                e.tags.name = e.tags.name || '飲水機';
                e.tags.level = e.tags.level ? (+e.tags.level < 0 ? '地下 ' + -e.tags.level : e.tags.level) + ' 樓' : undefined;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = '<div>'
                  + '<div class="name">' + e.tags.name + '</div>'
                  + '<div class="water">'
                  + (e.tags.iced_water ? '<img src="iced.png"/>' : '')
                  + (e.tags.cold_water ? '<img src="cold.png"/>' : '')
                  + (e.tags.warm_water ? '<img src="warm.png"/>' : '')
                  + (e.tags.hot_water ? '<img src="hot.png"/>' : '')
                  + '</div>'
                  + (e.tags.description ? '<div class="description">' + e.tags.description + '</div>' : '')
                  + (e.tags.level ? '<div class="level">' + e.tags.level + '</div>' : '')
                  + '</div>';
                var marker = L.marker(pos, {
                    icon: waterDropIcon(),
                    fillColor: '#fa3',
                    fillOpacity: 0.5
                  })
                  .bindPopup(popup);
                this.instance.addLayer(marker);
              }
            },
            minZoomIndicatorOptions: {
              position: 'topright',
              minZoomMessageNoLayer: '',
              minZoomMessage: '',
            },
          });
          map.addLayer(l);
        };
      }

      map
        .addLayer(osmLayer())
        .on('load', drinkingWaterLayer())
        .on('load', locator.mapButton())
        .on('load', about.mapButton())
        .on('load', (function () {
          return function () {
            L.control.graphicScale({
              fill: 'hollow',
              imperial: false,
              updateWhenIdle: true
            }).addTo(this)
          }
        })())
        .on('load', function () {
        if (about.showNextTime()) {
          about.open()
        }
          if (!about.showNextTime()) {
            locator.start()
          }
        })

      function onReady () {
        about.mount()
        map
          .setView(new L.LatLng(25.0003133, 121.5388148), 15);
      }
      $(document).ready(onReady)
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-1674662-7', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>
